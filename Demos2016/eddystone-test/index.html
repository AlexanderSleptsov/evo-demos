<!DOCTYPE html>
<html>

<head>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>Eddystone Scan Test</title>

	<style>
	/* Make text bigger. */
	body {
	    font-size: 175%;
	    }

	/* Make buttons bigger. */
	button {
	    font-size: 100%;
	    padding: 10%;
	    }
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.
	if (window.hyper && window.hyper.log) { console.log = hyper.log }
	</script>

</head>

<body>

	<h1>Eddystone Scan Test</h1>

	<button onclick="app.startScan()">Start scan</button>
	<button onclick="app.stopScan()">Stop scan</button>

	<p id="info"></p>

	<script src="cordova.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/eddystone/eddystone.js"></script>
	<script src="libs/jquery/jquery.js"></script>

	<script>
	// Application object
	var app = {}

	// Create UPD socket when Cordova is loaded.
	document.addEventListener(
		'deviceready',
		function() { evothings.scriptsLoaded(app.init) },
		false)

	app.init = function()
	{
	}

	app.startScan = function()
	{
	    app.showInfo('Scanning...')

	    // Start scan.
	    evothings.eddystone.startScan(
            app.onBeaconFound,
            app.onError)
	}

	app.stopScan = function()
	{
	    app.showInfo('Stopped scanning')

	    // Start scan.
	    evothings.eddystone.stopScan()
	}

	app.onBeaconFound = function(beacon)
	{
		var distance = calculateBeaconDistance(beacon) || ''
		app.showInfo('Beacon found: ' + beacon.url + ' ' + distance)
	}

	app.onError = function(error)
	{
		app.showInfo('BLE error ' + error)
	}

	app.showInfo = function(info)
	{
		document.getElementById('info').innerHTML = info
		console.log(info)
	}

	// http://stackoverflow.com/questions/21338031/radius-networks-ibeacon-ranging-fluctuation
	// http://developer.radiusnetworks.com/2014/12/04/fundamentals-of-beacon-ranging.html
	function calculateBeaconDistance(beacon)
	{
		if (('number' == (typeof beacon.txPower)) &&
			('number' == (typeof beacon.rssi)))
		{
			return calculateAccuracy(beacon.txPower, beacon.rssi)
		}
		else
		{
			return null
		}
	}

	// http://stackoverflow.com/questions/21338031/radius-networks-ibeacon-ranging-fluctuation
	// http://developer.radiusnetworks.com/2014/12/04/fundamentals-of-beacon-ranging.html
	function calculateAccuracy(txPower, rssi)
	{
		if (rssi >= 0 || !txPower)
		{
			return null
		}

		// The beacon distance formula uses txPower at 1 meters, but the Eddystone
		// protocol reports the value at 0 meters. 41dBm is the signal loss that
		// occurs over 1 meter, so we subtract that from the reported txPower.
		var ratio = rssi * 1.0 / (txPower - 41)
		if (ratio < 1.0)
		{
			return Math.pow(ratio, 10)
		}
		else
		{
			var accuracy = (0.89976) * Math.pow(ratio, 7.7095) + 0.111
			return accuracy
		}
	}

	</script>

</body>

</html>
